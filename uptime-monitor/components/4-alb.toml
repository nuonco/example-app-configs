# =============================================================================
# NUON KUBERNETES MANIFEST COMPONENT - Application Load Balancer
# =============================================================================
#
# Deploys a Kubernetes Ingress resource that provisions an AWS Application
# Load Balancer via the AWS Load Balancer Controller.
#
# Schema: https://api.nuon.co/v1/general/config-schema?type=kubernetes-manifest
#
# -----------------------------------------------------------------------------
# CONFIGURATION KEYS
# -----------------------------------------------------------------------------
#
#   name          (required)  Component identifier for template references
#   type          (required)  Must be "kubernetes_manifest"
#   namespace     (required)  Kubernetes namespace for deployment
#   manifest      (required)  Path to manifest YAML or inline YAML content
#   dependencies  (optional)  Components that must deploy first
#
# -----------------------------------------------------------------------------
# MANIFEST LOCATION
# -----------------------------------------------------------------------------
#
# The Kubernetes manifest is in: ./4-alb/manifest.yaml (relative to this file)
# Contains an Ingress resource with ALB annotations for routing.
#
# =============================================================================


# Component name.
name = "application_load_balancer"

# Component type for Kubernetes manifests.
type = "kubernetes_manifest"

# Kubernetes namespace.
namespace = "default"

# Dependencies ensure all services are deployed before creating the load balancer.
# The ALB routes traffic to UI and Headlamp services.
dependencies = ["ui", "headlamp"]

# Inline manifest containing the Ingress resource.
manifest = """
# -----------------------------------------------------------------------------
# Application Load Balancer Ingress for Uptime Monitor
# -----------------------------------------------------------------------------
#
# Nuon template variables used in this manifest:
#
#   Labels:
#     {{ .nuon.install.id }}  <- Unique install identifier
#
#   DNS (external-dns annotation):
#     {{ .nuon.install.sandbox.outputs.nuon_dns.public_domain.name }}
#
# This Ingress creates an AWS ALB via the AWS Load Balancer Controller.
# External-DNS automatically creates a Route53 record for the public domain.
#
# -----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: alb
  namespace: default
  labels:
    # Nuon install ID for resource tracking
    app.nuon.co/install: "{{ .nuon.install.id }}"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80}]'
    alb.ingress.kubernetes.io/healthcheck-path: "/"
    # Public domain from sandbox DNS configuration
    external-dns.alpha.kubernetes.io/hostname: "{{ .nuon.install.sandbox.outputs.nuon_dns.public_domain.name }}"
spec:
  ingressClassName: alb
  rules:
    - http:
        paths:
          - path: /headlamp
            pathType: Prefix
            backend:
              service:
                name: headlamp
                port:
                  number: 80
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ui
                port:
                  number: 80
"""
