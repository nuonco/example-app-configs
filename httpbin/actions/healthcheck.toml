# action
name    = "healthcheck"
timeout = "30s"

[[triggers]]
type = "manual"

[[steps]]
name = "check_httpbin"
inline_contents = """
#!/usr/bin/env sh
set -e

# Get the public IP from AWS
PUBLIC_IP=$(aws ec2 describe-instances \
  --filters "Name=tag:nuon-install-id,Values=${INSTALL_ID}" \
  --query 'Reservations[0].Instances[0].PublicIpAddress' \
  --output text \
  --region ${REGION})

echo "Checking health of httpbin at: http://${PUBLIC_IP}"

# Make the health check request
STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${PUBLIC_IP}/status/200")

if [ "$STATUS" = "200" ]; then
  echo "✓ Health check passed! Got status code: $STATUS"
  exit 0
else
  echo "✗ Health check failed! Got status code: $STATUS"
  exit 1
fi
"""

[steps.env_vars]
INSTALL_ID = "{{.nuon.install.id}}"
REGION = "{{.nuon.sandbox.outputs.account.region}}"
