{{ $region := .nuon.cloud_account.aws.region }} set -e set -o pipefail set -u

<center>
  <img src="https://mintlify.s3-us-west-1.amazonaws.com/nuoninc/logo/dark.svg"/>
  <h1>Clickhouse</h1>
  <small>
{{ if .nuon.install_stack.outputs }}
AWS | {{ dig "account_id" "000000000000" .nuon.install_stack.outputs }} | {{ dig "region" "xx-vvvv-00" .nuon.install_stack.outputs }} | {{ dig "vpc_id" "vpc-000000" .nuon.install_stack.outputs }}
{{ else }}
AWS | 000000000000 | xx-vvvv-00 | vpc-000000
{{ end }}
  </small>
</center>

A simple app config is for a simple cluster with two replicas and one shard, a 3-node keeper cluster, and a ui. The
cluster and UI are made publicly accessible for the purposes of this demo.

{{ if and .nuon.install_stack.populated }}

## Installation

{{ if .nuon.install_stack.quick_link_url }}

- [AWS CloudFormation QuickLink URL]({{ .nuon.install_stack.quick_link_url }}) {{ else }}
- Generating Quick Link

{{ end }}

{{ if .nuon.install_stack.template_url }}

- [AWS CloudFormation Template URL]({{ .nuon.install_stack.template_url }})
- [Compose
  Preview](https://{{ $region }}.console.aws.amazon.com/composer/canvas?region={{ $region }}&templateURL={{ .nuon.install_stack.template_url}}&srcConsole=cloudformation)
  {{ else }}
- Generating CloudFormation Template URL

{{ end }}

<details>
<summary>Full Template</summary>
{{ $template := .nuon.install_stack.template_json | fromJson }}
<pre>{{ $template | toPrettyJson }}</pre>
</details>
{{ else }}
No install stack configured.
{{ end }}

## Components

This demo deploys a 2-node replicated clickhouse cluster and a corresponding 3-node keeper cluster to support
replication. The clickhouse cluster is controlled by a ClickHouseInstallation (chi) CRD deployed in the
`clickhouse-installation` namespace. The keepers are controlled by a `ClickHouseKeeper` (chk) CRD deployed in the
`clickhouse-keeper` namespace. The installation and keepers are given their own nodepool to reduce the likelihood of
resource contention.

We also deploy a clickhouse ui which, for the purposes of this demonstration, is made public.

{{ if .nuon.sandbox.outputs }}

| Service | URL                                                                                                                                    |
| ------- | -------------------------------------------------------------------------------------------------------------------------------------- |
| ch-ui   | [ch-ui.{{ .nuon.sandbox.outputs.nuon_dns.public_domain.name }}](https://ch-ui.{{ .nuon.sandbox.outputs.nuon_dns.public_domain.name }}) |
| ch      | [ch.{{ .nuon.sandbox.outputs.nuon_dns.public_domain.name }}](https://ch.{{ .nuon.sandbox.outputs.nuon_dns.public_domain.name }})       |

{{ else }} Results will be visible after the sandbox is deployed. {{ end }}

Note: All of these URLs are public and avaialable on the open internet for the purpose of this demo.

## Actions

We have a few examples of actions in this app.

|                     | Trigger   | Description                                                                                |
| ------------------- | --------- | ------------------------------------------------------------------------------------------ |
| `ch_operator_creds` | automatic | Copies the autogenerated secrets into the cluster in the shape the operator expects.       |
| `ch_data_dbpedia`   | manual    | Creates a database and a 1ReplicatedMergeTree` table and copies part of a dataset into it. |

If you run the `ch_data_dbpedia`, you can then navigate to the ch-ui and explore the data. We use part of the
[dbpedia dataset](https://clickhouse.com/docs/getting-started/example-datasets/dbpedia-dataset#load-table).

## Accessing the EKS Cluster

In a BYOC context, access to the cluster is limited. For clusters you control, you can do the follwoing:

1. Add an access entry for the relevant role.
2. Grant the following perms: AWSEKSAdmin, AWSClusterAdmin.
3. Add the cluster kubeconfig w/ the following command.

<pre>
aws --region {{ .nuon.install_stack.outputs.region }} \
    --profile your.Profile eks update-kubeconfig      \
    --name {{ dig "outputs" "cluster" "name" "$cluster_name" .nuon.sandbox }} \
    --alias {{ dig "outputs" "cluster" "name" "$cluster_name" .nuon.sandbox }}
</pre>

## State

### Install Stack

<details>
  <summary>Install Stack</summary>
  <pre>{{ toPrettyJson .nuon.install_stack }}</pre>
</details>

### Sandbox

Visible in the "Sandbox" Tab.

### Actions

<details>
<summary>.nuon.actions</summary>
<pre>{{ toPrettyJson .nuon.actions }}</pre>
</details>

### Components

See also the "Components" Tab.

<details>
<summary>.nuon.components</summary>
<pre>{{ toPrettyJson .nuon.components }}</pre>
</details>

### Inputs

<details>
<summary>.nuon.inputs</summary>
<pre>{{ toPrettyJson .nuon.inputs }}</pre>
</details>

### Full State

In the top right of this page, click "Manage" > "View State".
