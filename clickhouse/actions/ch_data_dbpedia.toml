# action
# copies and munges the autogenerated operator secret into a format the chart knows how to use
name    = "ch_data_dbpedia"
timeout = "2m"

[[triggers]]
type           = "post-deploy-component"
component_name = "clickhouse_cluster"

[[triggers]]
type = "manual"

[[steps]]
name    = "ensure_db"
inline_contents = """
#!/usr/bin/env sh

set -e
set -o pipefail
set -u

pod=`kubectl -n clickhouse get pods --selector clickhouse.altinity.com/chi=clickhouse-installation -o json | jq -r '.items[0].metadata.name'`

kubectl --namespace=clickhouse exec -i $pod -- \
  clickhouse client -q "CREATE DATABASE IF NOT EXISTS dbpedia ON CLUSTER cluster"
"""

[[steps]]
name    = "ensure_table"
inline_contents = """
#!/usr/bin/env sh

set -e
set -o pipefail
set -u

pod=`kubectl -n clickhouse get pods --selector clickhouse.altinity.com/chi=clickhouse-installation -o json | jq -r '.items[0].metadata.name'`

kubectl --namespace=clickhouse exec -i $pod -- \
  clickhouse client -d dbpedia -q "CREATE TABLE IF NOT EXISTS dbpedia ON CLUSTER cluster (id String, title String, text String, vector Array(Float32) CODEC(NONE)) ENGINE = ReplicatedMergeTree ORDER BY (id);"
"""

# NOTE(fd): this is for demonstration purposes only. in practice, this may be done by a standalone deployment or similar for better control over the environment on which it is executed.
[[steps]]
name    = "load_part_0"
inline_contents = """
#!/usr/bin/env sh

set -e
set -o pipefail
set -u

# get a pod
echo "getting a pod"
pod=`kubectl -n clickhouse get pods --selector clickhouse.altinity.com/chi=clickhouse-installation -o json | jq -r '.items[0].metadata.name'`
echo " > got a pod: $pod"

echo "downloading file"
filepath="/var/lib/clickhouse/user_files/0.parquet"
url="https://huggingface.co/api/datasets/Qdrant/dbpedia-entities-openai3-text-embedding-3-large-1536-1M/parquet/default/train/0.parquet"
cmd="wget $url -O $filepath"
kubectl --namespace=clickhouse exec -i $pod -- $cmd

echo "preparing sql"
sql='INSERT INTO dbpedia.dbpedia SELECT _id, title, text, "text-embedding-3-large-1536-embedding"'" FROM file('"$filepath"') SETTINGS max_http_get_redirects=5,enable_url_encoding=0;"
echo " > sql: $sql"

echo "preparing to execute sql on pod"
kubectl --namespace=clickhouse exec -i $pod -- clickhouse client -d dbpedia -q "$sql"

echo "cleaning up"
kubectl --namespace=clickhouse exec -i $pod -- rm $filepath
"""
