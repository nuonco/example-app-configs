# action
# copies and munges the autogenerated operator secret into a format the chart knows how to use
name    = "ch_ingress_healthcheck"
timeout = "30s"

[[triggers]]
type           = "post-deploy-component"
component_name = "clickhouse_ingress"

[[triggers]]
type           = "pre-deploy-component"
component_name = "ch_ui"

[[triggers]]
type = "manual"

[[steps]]
name    = "check"
inline_contents = """
#!/usr/bin/env sh

OUTPUTS='{"status_indicator": "âšªï¸", "address": null, "status": null}'

# get the status
status=`kubectl get ingress -n clickhouse "clickhouse-$NUON_INSTALL_ID" -o json | jq '.status'`

# write the status to OUTPUTS in the "status" key with jq
OUTPUTS=`echo $OUTPUTS | jq --argjson status "$status" '.status = $status'`

# check for the loadBalancer and ingress.
# if they exist
# - add the value of loadBalancer.ingress[0].address to the output payload in the "address" field.
# - set the status_indicator value in the OUTPUTS to ðŸŸ¢
# if there are no load balancers or ingress
# - set the status to ðŸŸ 
ingress=`echo $status | jq '.loadBalancer.ingress'`

if [ "$ingress" != "null" ] && [ -n "$ingress" ]; then
  address=`echo $status | jq -r '.loadBalancer.ingress[0].hostname // .loadBalancer.ingress[0].ip // empty'`
  OUTPUTS=`echo $OUTPUTS | jq --arg addr "$address" '.address = $addr | .status_indicator = "ðŸŸ¢"'`
else
  OUTPUTS=`echo $OUTPUTS | jq '.status_indicator = "ðŸŸ "'`
fi

echo $OUTPUTS >> $NUON_ACTIONS_OUTPUT_FILEPATH
"""

