{{ $region := .nuon.cloud_account.aws.region }}

<center>
  <img src="https://mintlify.s3-us-west-1.amazonaws.com/nuoninc/logo/dark.svg"/>
  <h1>Clickhouse + Tailscale</h1>
  <small>
{{ if .nuon.install_stack.outputs }}
AWS | {{ dig "account_id" "000000000000" .nuon.install_stack.outputs }} | {{ dig "region" "xx-vvvv-00" .nuon.install_stack.outputs }} | {{ dig "vpc_id" "vpc-000000" .nuon.install_stack.outputs }}
{{ else }}
AWS | 000000000000 | xx-vvvv-00 | vpc-000000
{{ end }}
  </small>
</center>

A simple app config with a clickhouse db on a private subnet + tailscale for access. Deploys a simple replicated cluster
with two replicas and one shard plus a 3-node keeper cluster.

{{ if and .nuon.install_stack.populated }}

## Installation

{{ if .nuon.install_stack.quick_link_url }}

- [AWS CloudFormation QuickLink URL]({{ .nuon.install_stack.quick_link_url }}) {{ else }}
- Generating Quick Link

{{ end }}

{{ if .nuon.install_stack.template_url }}

- [AWS CloudFormation Template URL]({{ .nuon.install_stack.template_url }})
- [Compose
  Preview](https://{{ $region }}.console.aws.amazon.com/composer/canvas?region={{ $region }}&templateURL={{ .nuon.install_stack.template_url}}&srcConsole=cloudformation)
  {{ else }}
- Generating CloudFormation Template URL

{{ end }}

<details>
<summary>Full Template</summary>
{{ $template := .nuon.install_stack.template_json | fromJson }}
<pre>{{ $template | toPrettyJson }}</pre>
</details>
{{ else }}
No install stack configured.
{{ end }}

## Components

### Tailscale

This demo deploys the tailscale kubernetes operator. Before getting started, ensure the following:

1. MagicDNS is enabled on your tailnet.
2. HTTPS is enabled on your tailnet.
3. Tags for the operator are set up.
4. An Oauth App has been created and the credentials are available for use in the CloudFormation stack.

See docs here: https://tailscale.com/kb/1236/kubernetes-operator

### Clickhouse

This demo deploys a 2-node replicated clickhouse cluster and a corresponding 3-node keeper cluster to support
replication. The clickhouse cluster is controlled by a ClickHouseInstallation (chi) CRD deployed in the
`clickhouse-installation` namespace. The keepers are controlled by a `ClickHouseKeeper` (chk) CRD deployed in the
`clickhouse-keeper` namespace. The installation and keepers are given their own nodepool to reduce the likelihood of
resource contention.

We also deploy a clickhouse ui which, for the purposes of this demonstration, is made public.

### Services on the Tailnet

<!-- prettier-ignore-start -->
| Service | Tailnet Address |
| ------- | --------------- |
{{ if and .nuon.actions.workflows.ch_ingress_healthcheck .nuon.actions.workflows.ch_ingress_healthcheck.populated .nuon.actions.workflows.ch_ingress_healthcheck.outputs.steps }}| clickhouse | https://{{ .nuon.actions.workflows.ch_ingress_healthcheck.outputs.steps.check.address }} |{{ else }}
| clickhouse | ... |{{ end }}
{{ if and .nuon.actions.workflows.ch_ui_ingress_healthcheck .nuon.actions.workflows.ch_ui_ingress_healthcheck.populated .nuon.actions.workflows.ch_ui_ingress_healthcheck.outputs.steps }}| ch-ui | https://{{ .nuon.actions.workflows.ch_ui_ingress_healthcheck.outputs.steps.check.address }} |{{ else }}| ch-ui | ... |{{ end }}
<!-- prettier-ignore-end -->

## Actions

We have a few examples of actions in this app.

|                             | Trigger   | Description                                                                                |
| --------------------------- | --------- | ------------------------------------------------------------------------------------------ |
| `ch_operator_creds`         | automatic | Copies the autogenerated secrets into the cluster in the shape the operator expects.       |
| `ch_data_dbpedia`           | manual    | Creates a database and a 1ReplicatedMergeTree` table and copies part of a dataset into it. |
| `ch_ui_ingress_healthcheck` | automatic | Checks the status of the tailscale ingress for ch-ui.                                      |
| `ch_ingress_healthcheck`    | automatic | Checks the status of the tailscale ingress for the clickhouse cluster.                     |

If you run the `ch_data_dbpedia`, you can then navigate to the ch-ui and explore the data. We use part of the
[dbpedia dataset](https://clickhouse.com/docs/getting-started/example-datasets/dbpedia-dataset#load-table).

## Accessing the EKS Cluster

In a BYOC context, access to the cluster is limited. For clusters you control, you can do the following:

1. Add an access entry for the relevant role.
2. Grant the following perms: AWSEKSAdmin, AWSClusterAdmin.
3. Add the cluster kubeconfig w/ the following command.

<pre>
aws --region {{ .nuon.install_stack.outputs.region }} \
    --profile your.Profile eks update-kubeconfig      \
    --name {{ dig "outputs" "cluster" "name" "$cluster_name" .nuon.sandbox }} \
    --alias {{ dig "outputs" "cluster" "name" "$cluster_name" .nuon.sandbox }}
</pre>

## State

In the top right of this page, click "Manage" > "View State" to view this install's state.
